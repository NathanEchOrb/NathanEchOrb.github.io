name: Update File Manifest

on:
  push:
    branches: [ main ]
    paths:
      - 'docs/**'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-manifest:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      
    - name: Generate files.json
      run: |
        cd docs
        # Create JSON array of all HTML files sorted by date in filename
        echo "[" > files.json
        
        # Find HTML files, extract dates, sort by date (newest first), then format as JSON
        find . -maxdepth 1 -name "*.html" -type f | sed 's|^\./||' | \
        awk -F'_' '{
          # Extract MM-DD-YY from end of filename
          # Pattern: opportunities_Xdays_MM-DD-YY.html or M-D-YY.html
          last_part = $NF;
          gsub(/\.html$/, "", last_part);
          
          # Split by dash to get date components
          n = split(last_part, date_parts, "-");
          
          if (n >= 3) {
            # Get MM, DD, YY - convert to integers to handle leading zeros
            mm = date_parts[1] + 0;
            dd = date_parts[2] + 0;
            yy = date_parts[3] + 0;
            
            # Convert to YYYYMMDD for sorting (20YY-MM-DD)
            sort_date = sprintf("20%02d%02d%02d", yy, mm, dd);
            print sort_date " " $0;
          } else {
            # If no date found, use 00000000 to sort to end
            print "00000000 " $0;
          }
        }' | \
        sort -r | \
        awk '{print $2}' | \
        awk '{printf "    \"%s\"", $0; if (NR > 1) printf ",\n"; else printf "\n";}' | tac >> files.json
        
        echo "]" >> files.json
        
    - name: Commit changes
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add docs/files.json
        git diff --quiet && git diff --staged --quiet || git commit -m "Auto-update file manifest"
        
    - name: Push changes
      uses: ad-m/github-push-action@master
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        branch: ${{ github.ref }}